<launch>
  <arg name="use_viewer" default="true" />
  <arg name="odom_topic" default="/diy_odom" />
  <arg name="motor_topic" default="/quad/motor_cmd" />
  <arg name="rgb_topic" default="/diy_img/rgb/image_raw" />
  <arg name="depth_topic" default="/diy_img/depth/image_raw" />
  <arg name="camera_info_topic" default="/diy_img/camera_info" />
  <arg name="position_cmd_topic" default="/uam_controller/cmd" />
  <arg name="controller_pose_topic" default="/uam_controller/cmd_pose" />
  <arg name="use_controller_setpoint" default="false" />
  <arg name="target_topic" default="/target_ekf_odom" />
  <arg name="yolo_topic" default="/target_3d_position" />
  <arg name="rho_visibility" default="10000.0" />
  <arg name="rho_tracking" default="1000.0" />

  <!-- MuJoCo simulator -->
  <node pkg="py_sim" type="quad_ros.py" name="quad_ros" output="screen">
    <param name="enable_viewer" value="$(arg use_viewer)" />
    <param name="odom_topic" value="$(arg odom_topic)" />
    <param name="motor_topic" value="$(arg motor_topic)" />
    <param name="rgb_topic" value="$(arg rgb_topic)" />
    <param name="depth_topic" value="$(arg depth_topic)" />
    <param name="camera_info_topic" value="$(arg camera_info_topic)" />
  </node>

  <!-- Convert planner PositionCommand to controller PoseStamped -->
  <node pkg="uam_controller" type="position_command_to_pose.py" name="position_cmd_to_pose" output="screen">
    <param name="input_topic" value="$(arg position_cmd_topic)" />
    <param name="output_topic" value="$(arg controller_pose_topic)" />
  </node>

  <!-- Controller stack -->
  <include file="$(find uam_controller)/launch/uam_controller.launch">
    <arg name="odom_topic" value="$(arg odom_topic)" />
    <arg name="setpoint_topic" value="$(arg controller_pose_topic)" />
    <arg name="motor_topic" value="$(arg motor_topic)" />
    <arg name="cmd_topic" value="$(arg controller_pose_topic)" />
    <arg name="use_setpoint_publisher" value="$(arg use_controller_setpoint)" />
  </include>

  <!-- Planning and perception modules -->
  <include file="$(find planning)/launch/planning.launch">
    <arg name="rhosVisibility_" value="$(arg rho_visibility)" />
    <arg name="rhoTracking_" value="$(arg rho_tracking)" />
    <arg name="target_name_" value="$(arg target_topic)" />
    <arg name="odom_topic_" value="$(arg odom_topic)" />
    <arg name="position_cmd_topic" value="$(arg position_cmd_topic)" />
  </include>

  <include file="$(find d2p)/launch/d2p.launch">
    <arg name="image_topic" value="$(arg rgb_topic)" />
    <arg name="depth_topic" value="$(arg depth_topic)" />
    <arg name="odom_topic" value="$(arg odom_topic)" />
    <arg name="use_rviz" value="false" />
  </include>

  <include file="$(find mapping)/launch/mapping.launch">
    <arg name="odom_topic" value="$(arg odom_topic)" />
    <arg name="depth_topic" value="$(arg depth_topic)" />
    <arg name="target_topic" value="$(arg target_topic)" />
    <arg name="use_rviz" value="false" />
  </include>

  <include file="$(find target_ekf)/launch/target_ekf.launch">
    <arg name="odom_topic" value="$(arg odom_topic)" />
    <arg name="yolo_topic" value="$(arg yolo_topic)" />
    <arg name="target_topic" value="$(arg target_topic)" />
  </include>

  <!-- Visualisation -->
  <node pkg="rviz" type="rviz" name="rviz" args="-d $(find mapping)/config/rviz_sim.rviz" />
</launch>
